#!/bin/sh

echo "üîß –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫ –ø–∞–∫–µ—Ç–æ–≤..."
opkg update

# –°–ø–∏—Å–æ–∫ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
DEPS="ipset ipt2socks iptables iptables-legacy iptables-mod-conntrack-extra iptables-mod-iprange iptables-mod-socket iptables-mod-tproxy kmod-ipt-nat dnsmasq-full"

echo "üîç –ü—Ä–æ–≤–µ—Ä—è–µ–º –∏ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—â–∏–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏..."
for pkg in $DEPS; do
  if ! opkg list-installed | grep -qw "$pkg"; then
    echo "üì¶ –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º $pkg..."
    opkg install "$pkg"
    if [ $? -ne 0 ]; then
      echo "‚ùå –û—à–∏–±–∫–∞ —É—Å—Ç–∞–Ω–æ–≤–∫–∏ $pkg"
    else
      echo "‚úÖ $pkg —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω"
    fi
  else
    echo "‚úÖ $pkg —É–∂–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω"
  fi
done

BASE_URL="https://github.com/elagor1996/xray_file/raw/main/passwall"

echo "üéØ –ó–∞–≥—Ä—É–∂–∞–µ–º —Å–ø–∏—Å–æ–∫ —Ñ–∞–π–ª–æ–≤ —Å $BASE_URL/_files.txt..."
curl -fsSL -o /tmp/_files.txt "$BASE_URL/_files.txt" || {
  echo "‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–ø–∏—Å–∫–∞ —Ñ–∞–π–ª–æ–≤"
  exit 1
}

echo "üì¶ –ù–∞—á–∏–Ω–∞–µ–º —Å–∫–∞—á–∏–≤–∞–Ω–∏–µ –∏ —É—Å—Ç–∞–Ω–æ–≤–∫—É –ø–∞–∫–µ—Ç–æ–≤ –∏–∑ —Å–ø–∏—Å–∫–∞..."

grep -v '^\s*#' /tmp/_files.txt | while read -r filename; do
  [ -z "$filename" ] && continue

  echo "‚¨áÔ∏è –°–∫–∞—á–∏–≤–∞–µ–º '$filename'..."
  curl -fsSL -o "/tmp/$filename" "$BASE_URL/$filename"
  if [ $? -ne 0 ]; then
    echo "‚ùå –û—à–∏–±–∫–∞ —Å–∫–∞—á–∏–≤–∞–Ω–∏—è $filename"
    continue
  fi

  echo "üì¶ –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º $filename..."
  opkg install "/tmp/$filename"
  if [ $? -ne 0 ]; then
    echo "‚ùå –û—à–∏–±–∫–∞ —É—Å—Ç–∞–Ω–æ–≤–∫–∏ $filename"
  else
    echo "‚úÖ $filename —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω —É—Å–ø–µ—à–Ω–æ"
  fi
done

echo "‚úÖ –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –ø–∞–∫–µ—Ç–æ–≤ –∏–∑ —Å–ø–∏—Å–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞!"
exit 0
